<?php	session_start();	if ($_SESSION['print_admin'] !== '#$ok*%'){		header("location: ../admin/login.php");	}?><!DOCTYPE HTML><html lang="fa-IR"><head>	<meta charset="utf-8"/>	<title>پنل مدیریت | شمیم</title>	<link rel="stylesheet" type="text/css" href="../admin/library/style.css">	<meta name="viewport" content="width=device-width, initial-scale=1">	<script src="../admin/library/main.js"></script>    <link type="text/css" href="styles/jquery-ui-1.8.14.css" rel="stylesheet" />      <script type="text/javascript" src="scripts/jquery-1.6.2.min.js"></script>	<script type="text/javascript" src="scripts/jquery.ui.core.js"></script>    <script type="text/javascript" src="scripts/jquery.ui.datepicker-cc.js"></script>    <script type="text/javascript" src="scripts/calendar.js"></script>    <script type="text/javascript" src="scripts/jquery.ui.datepicker-cc-fa.js"></script>    <script type="text/javascript">	    $(function() {	        // استفاده از dropdown	        $('#datepicker1').datepicker({	            changeMonth: true,	            changeYear: true	        });			       $('#datepicker2').datepicker({	            changeMonth: true,	            changeYear: true	        });			      $('#datepicker3').datepicker({	            changeMonth: true,	            changeYear: true	        });				      $('#datepicker4').datepicker({	            changeMonth: true,	            changeYear: true	        });	        //-----------------------------------	    });    </script>    <script>     function refresh() { setTimeout(function(){window.location.reload();  },1000)     }</script>    <style type="text/css">        *		p.ui-state-hover		{			font-weight: normal;		}        p.ui-widget-header        {            text-align: center;            font-weight: normal;        }        strong.ui-state-error        {            display: block;            padding: 3px;            text-align: center;        }    </style></head><body><?$username=$_GET['username'];?>        <h2 class="user-panel-sheet-h2">لیست فاکتور های شرکت<?= $username?></h2><?php	require ('../db_select.php');require('library/jdf.php');	parse_str($_SERVER['QUERY_STRING']);if (isset($do) && $do != '' && isset($invoiceID) && $invoiceID != '') {	if ($do == 'delete') {			$delete_invoice ="DELETE FROM invoices WHERE invoice_code='$invoiceID'";			if (!mysqli_query($connection,$delete_invoice))			{			die('Error: ' . mysqli_error());				echo "مشکلی در روند حذف فاکتور به وجود آمد و فاکتور حذف نگردید.";			}			else{			echo "<span class=\"done-alert\">فاکتور مورد نظر با موفقیت حذف گردید.</span>";			}		 include('../avclass.php');		 del_invoice($username);	}	elseif ($do == 'paid') {		$sql_paid_invoice = "UPDATE invoices SET is_paid = $pay WHERE invoice_code = '$invoiceID'";		mysqli_query($connection, "SET NAMES 'utf8'");		mysqli_query($connection, "SET CHARACTER SET 'utf8'");		mysqli_query($connection, "SET character_set_connection = 'utf8'");		if ($connection->query($sql_paid_invoice) === TRUE) {			echo "<span class=\"edit-done-alert\">وضعیت فاکتور مربوطه   تغییر یافت</span>";		} else {    echo "مشکلی در تغییر وضعیت پرداخت فاکتور به وجود آمد: " . $sql . "<br>" . $connection->error;		}	}}if (isset($username)){	$username_text="&username=$username";	$sql1=	$sql_invoices = mysqli_query($connection, "SELECT fc ,order_userFROM(SELECT factor as fc,order_user  FROM orders2  GROUP BY factor  UNION ALL  SELECT order_make_number_perforating as fc,order_user  FROM orders1  GROUP    BY order_make_number_perforating) as t3 where order_user='$username'GROUP BY fc");	$RecordCount = mysqli_num_rows($sql_invoices);	$showRecord = 40;	$pages = ceil($RecordCount / $showRecord);	if(isset($page) && $page != '' && $page >=  1){		$pageuse = $page - 1;		$start = ($pageuse * $showRecord);		$end = $showRecord;	}	else{		$start = 0;		$end = $showRecord;	}	$sql_invoices_of_user = mysqli_query($connection, "SELECT fc ,order_userFROM(SELECT factor as fc,order_user  FROM orders2  GROUP BY factor  UNION ALL  SELECT order_make_number_perforating as fc,order_user  FROM orders1  GROUP    BY order_make_number_perforating) as t3 where order_user='$username'GROUP BY fc	 DESC LIMIT $start , $end");}else{		$sql_invoices = mysqli_query($connection, "SELECT fc ,order_userFROM(SELECT factor as fc,order_user  FROM orders2  GROUP BY factor  UNION ALL  SELECT order_make_number_perforating as fc,order_user  FROM orders1  GROUP    BY order_make_number_perforating) as t3GROUP BY fcDESC ");	$RecordCount = mysqli_num_rows($sql_invoices);	$showRecord = 40;	$pages = ceil($RecordCount / $showRecord);	if(isset($page) && $page != '' && $page >=  1){		$pageuse = $page - 1;		$start = ($pageuse * $showRecord);		$end = $showRecord;	}	else{		$start = 0;		$end = $showRecord;	}    $pay_method=$_POST['order-status-edit-select'];    $dates = $_POST['datepicker1'];    $dates2 = $_POST['datepicker2'];    $dates = explode('/', $dates);    $dates2 = explode('/', $dates2);    $resdate= strtotime(jalali_to_gregorian($dates[2] , $dates[1] ,$dates[0] ,'-'));    $resdate2= strtotime(jalali_to_gregorian($dates2[2] , $dates2[1] ,$dates2[0] ,'-'));    $datefrom = date('Y-m-d',$resdate);    $dateto =date('Y-m-d', $resdate2);	$sql_invoices_of_user = mysqli_query($connection, "SELECT * FROM factor where date(date_create) between '$datefrom' and '$dateto' and(order_last_status=$pay_method or order_last_status2=$pay_method or order_last_status3=$pay_method or order_last_status4=$pay_method ) order by date_show DESC ");	}function half_calc($sql_od_last_status_pay,$sql_od_last_status_pay2,$sql_od_last_status_pay3,$sql_od_last_status_pay4,$invoice_order_half,$invoice_order_half2,$invoice_order_half3,$invoice_order_half4,$sql_banner_total_price,$half_price,$half_price2,$half_price3,$half_price4,$half_price5,$half_price6){if ($sql_od_last_status_pay == '1') {	if(!empty($invoice_order_half)){    $half_price+=$invoice_order_half ;$half_row=$invoice_order_half;	}else{		$half_price+=$sql_banner_total_price;$half_row=$sql_banner_total_price;		}}elseif ($sql_od_last_status_pay == '2') {	if(!empty($invoice_order_half)){    $half_price2+=$invoice_order_half ;$half_row2=$invoice_order_half;	}else{		$half_price2+=$sql_banner_total_price;$half_row2=$sql_banner_total_price;			}}elseif ($sql_od_last_status_pay == '3') {	if(!empty($invoice_order_half)){    $half_price3+=$invoice_order_half; ;$half_row3=$invoice_order_half;	}else{		$half_price3+=$sql_banner_total_price;$half_row3=$sql_banner_total_price;			}}elseif ($sql_od_last_status_pay == '4') {	if(!empty($invoice_order_half)){    $half_price4+=$invoice_order_half;	$half_row4=$invoice_order_half;	}else{		$half_price4+=$sql_banner_total_price;$half_row4=$sql_banner_total_price;			}}elseif ($sql_od_last_status_pay == '5') {	if(!empty($invoice_order_half)){    $half_price5+=$invoice_order_half;	$half_row5=$invoice_order_half;	}else{		$half_price5+=$sql_banner_total_price;$half_row5=$sql_banner_total_price;			}}elseif ($sql_od_last_status_pay == '6') {    if(!empty($invoice_order_half)){        $half_price6+=$invoice_order_half;	$half_row6=$invoice_order_half;    }else{        $half_price6+=$sql_banner_total_price;$half_row6=$sql_banner_total_price;    }}if ($sql_od_last_status_pay2 == '1') {	if(!empty($invoice_order_half2)){    $half_price+=$invoice_order_half2;$half_row=$invoice_order_half2;	}else{		$half_price+=$sql_banner_total_price;$half_row=$sql_banner_total_price;			}}elseif ($sql_od_last_status_pay2 == '2') {	if(!empty($invoice_order_half2)){    $half_price2+=$invoice_order_half2;$half_row2=$invoice_order_half2;	}else{		$half_price2+=$sql_banner_total_price;$half_row2=$sql_banner_total_price;			}}elseif ($sql_od_last_status_pay2 == '3') {	if(!empty($invoice_order_half2)){    $half_price3+=$invoice_order_half2;$half_row3=$invoice_order_half2;	}else{		$half_price3+=$sql_banner_total_price;$half_row3=$sql_banner_total_price;			}}elseif ($sql_od_last_status_pay2 == '4') {	if(!empty($invoice_order_half2)){    $half_price4+=$invoice_order_half2;$half_row4=$invoice_order_half2;	}else{		$half_price4+=$sql_banner_total_price;$half_row4=$sql_banner_total_price;			}}elseif ($sql_od_last_status_pay2 == '5') {	if(!empty($invoice_order_half2)){    $half_price5+=$invoice_order_half2;$half_ro5w=$invoice_order_half2;	}else{		$half_price5+=$sql_banner_total_price;$half_row5=$sql_banner_total_price;			}}if ($sql_od_last_status_pay3 == '1') {	if(!empty($invoice_order_half3)){    $half_price+=$invoice_order_half3;$half_row=$invoice_order_half3;	}else{		$half_price+=$sql_banner_total_price;$half_row=$sql_banner_total_price;			}}elseif ($sql_od_last_status_pay3 == '2') {	if(!empty($invoice_order_half3)){    $half_price2+=$invoice_order_half3;$half_row2=$invoice_order_half3;	}else{		$half_price2+=$sql_banner_total_price;$half_row2=$sql_banner_total_price;			}}elseif ($sql_od_last_status_pay3 == '3') {	if(!empty($invoice_order_half3)){    $half_price3+=$invoice_order_half3;$half_row3=$invoice_order_half3;	}else{		$half_price3+=$sql_banner_total_price;$half_row3=$sql_banner_total_price;			}}elseif ($sql_od_last_status_pay3 == '4') {	if(!empty($invoice_order_half3)){    $half_price4+=$invoice_order_half3;$half_row4=$invoice_order_half3;	}else{		$half_price4+=$sql_banner_total_price;$half_row4=$sql_banner_total_price;			}}elseif ($sql_od_last_status_pay3 == '5') {	if(!empty($invoice_order_half3)){    $half_price5+=$invoice_order_half3;$half_row5=$invoice_order_half3;	}else{		$half_price5+=$sql_banner_total_price;$half_row5=$sql_banner_total_price;			 }}if ($sql_od_last_status_pay4 == '1') {	if(!empty($invoice_order_half4)){    $half_price+=$invoice_order_half4;$half_row=$invoice_order_half4;	}else{		$half_price+=$sql_banner_total_price;$half_row=$sql_banner_total_price;			}}elseif ($sql_od_last_status_pay4 == '2') {	if(!empty($invoice_order_half4)){    $half_price2+=$invoice_order_half4;$half_row2=$invoice_order_half4;	}else{		$half_price2+=$sql_banner_total_price;$half_row2=$sql_banner_total_price;			}}elseif ($sql_od_last_status_pay4 == '3') {	if(!empty($invoice_order_half4)){    $half_price3+=$invoice_order_half4;$half_row3=$invoice_order_half4;	}else{		$half_price3+=$sql_banner_total_price;$half_row3=$sql_banner_total_price;			}}elseif ($sql_od_last_status_pay4 == '4') {	if(!empty($invoice_order_half4)){    $half_price4+=$invoice_order_half4;$half_row4=$invoice_order_half4;	}else{		$half_price4+=$sql_banner_total_price;$half_row4=$sql_banner_total_price;			}}elseif ($sql_od_last_status_pay4 == '5') {	if(!empty($invoice_order_half4)){    $half_price5+=$invoice_order_half4;$half_row5=$invoice_order_half4;	}else{		$half_price5+=$sql_banner_total_price;$half_row5=$sql_banner_total_price;			}}	return array($half_price,$half_price2,$half_price3,$half_price4,$half_price5,$half_price6,$half_row,$half_row2,$half_row3,$half_row4,$half_row5,$half_row6);	}?>		<table width="100%" id="financial-invoices-table">			<tr>				<th>ردیف</th>				<th class="th-darker">شماره فاکتور</th>                <th >کاربر</th>                	<th  class="th-darker">سفارشات</th>                <th >مبلغ کل</th>                <th  class="th-darker">دریافتی</th>			</tr>			<tr><?php				$c = '1';				while($sql_invoices = mysqli_fetch_array($sql_invoices_of_user)){					$sql_invoice_code = $sql_invoices['id'];						$sql_user= $sql_invoices['operator'];						$invoice_order_half= $sql_invoices['order_half'];						$invoice_order_half2= $sql_invoices['order_half2'];						$invoice_order_half3= $sql_invoices['order_half3'];						$invoice_order_half4= $sql_invoices['order_half4'];						$order_discount=$sql_invoices['order_discount'];$sql_od_last_status_pay = $sql_invoices['order_last_status'];$sql_od_last_status_pay2 = $sql_invoices['order_last_status2'];$sql_od_last_status_pay3 = $sql_invoices['order_last_status3'];$sql_od_last_status_pay4 = $sql_invoices['order_last_status4'];					if (is_null($sql_invoice_deposit_date)) {						$sql_invoice_deposit_date = '-';					}				echo "<tr>";					echo "<td>$c</td>";					$c++;					echo "<td class=\"th-darker\">$sql_invoice_code</td>";					echo "<td class=\"th-darker\">$sql_user</td>";					echo "<td  valign=\"top\">";	if(!empty($sql_invoice_code)){					$sql_orders_of_banner= mysqli_query($connection, "SELECT * FROM orders1 where   order_make_number_perforating =$sql_invoice_code");					while($sql_banner = mysqli_fetch_array($sql_orders_of_banner)){                        $sql_order_last_status = $sql_banner['order_last_status'];                        if($sql_order_last_status!=6) {                            $sql_banner_total_price += $sql_banner['order_total_price'];                            $sql_banner_price = $sql_banner['order_total_price'];                        }						$sql_order_submit_date = $sql_banner['order_submit_date'];						 					$sql_od_lot_quantity = $sql_banner['order_lot_quantity'];						$sql_order_promise_date = $sql_banner['order_width']."X".$sql_banner['order_height'];					if ($sql_order_last_status == '0') {						$sql_order_ls = 'در انتظار پرداخت فاکتور';						$od_ls_0 = 'selected';					}					elseif ($sql_order_last_status == '1') {						$sql_order_ls = 'در انتظار بررسی';						$od_ls_1 = 'selected';					}					elseif ($sql_order_last_status == '2') {						$sql_order_ls = 'پروسه چاپ';						$od_ls_2 = 'selected';					}					elseif ($sql_order_last_status == '3') {						$sql_order_ls = 'آماده تحویل';						$od_ls_3 = 'selected';					}					elseif ($sql_order_last_status == '4') {						$sql_order_ls = 'تحویل داده شده';						$od_ls_4 = 'selected';					}					elseif ($sql_order_last_status == '5') {						$sql_order_ls = 'تعلیق کار';						$od_ls_5 = 'selected';					}						elseif ($sql_order_last_status == '6') {						$sql_order_ls = 'کنسل شد';						$od_ls_6 = 'selected';					}					elseif ($sql_order_last_status == '7') {						$sql_order_ls = 'تحویل شرکت';						$od_ls_7 = 'selected';					}					elseif ($sql_order_last_status == '8') {						$sql_order_ls = 'تحویل مشتری';						$od_ls_8 = 'selected';					}					elseif ($sql_order_last_status== '9') {						$sql_order_ls = 'تعلیق کارکاه';						$od_ls_9 = 'selected';					}					elseif ($sql_order_last_status == '10') {						$sql_order_ls = 'ویرایش کارگاه';						$od_ls_10 = 'selected';					}					else{						$sql_order_ls = 'وضعیت تعلیق';					}						echo "<table>";					echo "<td  $read_m>$sql_od_lot_quantity</td>";					echo "<td  $read_m>$sql_order_promise_date</td>";					echo "<td $read_m>$sql_order_ls</td>";						echo "</table>";					}}	$order_of_offset=  "SELECT * FROM orders2 where factor=$sql_invoice_code " ;	if(!empty($sql_invoice_code)){			$sql_orders_of_offset= mysqli_query($connection, $order_of_offset);						while($sql_offset = mysqli_fetch_array($sql_orders_of_offset)){                            $sql_order_last_status = $sql_offset['order_last_status'];                            if( $sql_order_last_status!=6) {                                $sql_offset_total_price += $sql_offset['order_total_price'];                                $sql_offset_price = $sql_offset['order_total_price'];                            }					$sql_order_type = $sql_offset['order_type'];					$sql_order_total_price = $sql_offset['order_total_price'];					$sql_order_submit_date =  jdate('Y/m/d h:i a',strtotime(   $sql_offset['order_submit_date'].' +210 minutes'),'none','Iran/Tehran','fa');					 					$sql_od_lot_quantity = $sql_offset['order_lot_quantity'];					$sql_order_print_permission = $sql_offset['order_print_permission'];					$sql_order_delivery_permission = $sql_offset['order_delivery_permission'];					$permission = $sql_offset['order_delivery_permission'];						if ($sql_order_last_status == '0') {						$sql_order_ls = 'در انتظار پرداخت فاکتور';						$od_ls_0 = 'selected';					}					elseif ($sql_order_last_status == '1') {						$sql_order_ls = 'در انتظار بررسی';						$od_ls_1 = 'selected';					}					elseif ($sql_order_last_status == '2') {						$sql_order_ls = 'پروسه چاپ';						$od_ls_2 = 'selected';					}					elseif ($sql_order_last_status == '3') {						$sql_order_ls = 'آماده تحویل';						$od_ls_3 = 'selected';					}					elseif ($sql_order_last_status == '4') {						$sql_order_ls = 'تحویل داده شده';						$od_ls_4 = 'selected';					}					elseif ($sql_order_last_status == '5') {						$sql_order_ls = 'تعلیق کار';						$od_ls_5 = 'selected';					}						elseif ($sql_order_last_status == '6') {						$sql_order_ls = 'کنسل شد';						$od_ls_6 = 'selected';					}					elseif ($sql_order_last_status == '7') {						$sql_order_ls = 'تحویل شرکت';						$od_ls_7 = 'selected';					}					elseif ($sql_order_last_status == '8') {						$sql_order_ls = 'تحویل مشتری';						$od_ls_8 = 'selected';					}					elseif ($sql_order_last_status== '9') {						$sql_order_ls = 'تعلیق کارکاه';						$od_ls_9 = 'selected';					}					elseif ($sql_order_last_status == '10') {						$sql_order_ls = 'ویرایش کارگاه';						$od_ls_10 = 'selected';					}					else{						$sql_order_ls = 'وضعیت تعلیق';					}					echo"<table>";					echo "<td  $read_m>$sql_od_lot_quantity</td>";					echo "<td $read_m>$sql_order_type</td>";					echo "<td $read_m>$sql_order_ls</td>";					echo "</table>";						}	$order_of_offset=  "SELECT * FROM orders3 where factor=$sql_invoice_code " ;	if(!empty($sql_invoice_code)){			$sql_orders_of_offset= mysqli_query($connection, $order_of_offset);						while($sql_offset = mysqli_fetch_array($sql_orders_of_offset)){						    $sql_order_last_status = $sql_offset['order_last_status'];                            if( $sql_order_last_status!=6) {                                $sql_accessories_total_price += $sql_offset['order_total_price'];                                $sql_accessories_price = $sql_offset['order_total_price'];                            }					$sql_order_type = $sql_offset['order_type'];					$sql_order_total_price = $sql_offset['order_total_price'];					$sql_order_submit_date = $sql_offset['order_submit_date'];					$sql_order_submit_date = $sql_offset['order_submit_date'];						 					$sql_od_lot_quantity = $sql_offset['order_lot_quantity'];					$sql_order_print_permission = $sql_offset['order_print_permission'];					$sql_order_delivery_permission = $sql_offset['order_delivery_permission'];					$permission = $sql_offset['order_delivery_permission'];						if ($sql_order_last_status == '0') {						$sql_order_ls = 'در انتظار پرداخت فاکتور';						$od_ls_0 = 'selected';					}					elseif ($sql_order_last_status == '1') {						$sql_order_ls = 'در انتظار بررسی';						$od_ls_1 = 'selected';					}					elseif ($sql_order_last_status == '2') {						$sql_order_ls = 'پروسه چاپ';						$od_ls_2 = 'selected';					}					elseif ($sql_order_last_status == '3') {						$sql_order_ls = 'آماده تحویل';						$od_ls_3 = 'selected';					}					elseif ($sql_order_last_status == '4') {						$sql_order_ls = 'تحویل داده شده';						$od_ls_4 = 'selected';					}					elseif ($sql_order_last_status == '5') {						$sql_order_ls = 'تعلیق کار';						$od_ls_5 = 'selected';					}						elseif ($sql_order_last_status == '6') {						$sql_order_ls = 'کنسل شد';						$od_ls_6 = 'selected';					}					elseif ($sql_order_last_status == '7') {						$sql_order_ls = 'تحویل شرکت';						$od_ls_7 = 'selected';					}					elseif ($sql_order_last_status == '8') {						$sql_order_ls = 'تحویل مشتری';						$od_ls_8 = 'selected';					}					elseif ($sql_order_last_status== '9') {						$sql_order_ls = 'تعلیق کارکاه';						$od_ls_9 = 'selected';					}					elseif ($sql_order_last_status == '10') {						$sql_order_ls = 'ویرایش کارگاه';						$od_ls_10 = 'selected';					}					else{						$sql_order_ls = 'وضعیت تعلیق';					}					echo"<table>";					echo "<td  $read_m>$sql_od_lot_quantity</td>";					echo "<td $read_m>$sql_order_type</td>";					echo "<td $read_m>$sql_order_ls</td>";					echo "</table>";						}					echo "</td>";	}$total_price=$sql_offset_total_price +$sql_banner_total_price+$sql_accessories_total_price-$order_discount;					$total_factor_price+=$total_price;        $return_half=half_calc($sql_od_last_status_pay,$sql_od_last_status_pay2,$sql_od_last_status_pay3,$sql_od_last_status_pay4,$invoice_order_half,$invoice_order_half2,$invoice_order_half3,$invoice_order_half4,$total_price,$return_half[0],$return_half[1],$return_half[2],$return_half[3],$return_half[4],$return_half[5]);					$sql_offset_total_price=0;					$sql_banner_total_price=0;					$sql_accessories_total_price=0;					echo "<td class=\"th-darker\" valign=\"top\">".number_format($total_price)." تومان</td>";echo "<td class=\"th-darker\" valign=\"top\">";if($return_half[6]!=0){echo"پرداخت نقدی: ".$return_half[6]; }if($return_half[7]!=0){echo"<br>POS پرداخت :".$return_half[7];}if($return_half[8]!=0){echo"<br>پرداخت چک :".$return_half[8];}if($return_half[9]!=0){echo"<br>واریزی حساب :".$return_half[9];}if($return_half[10]!=0){echo"<br>پرداخت حسابداری :".$return_half[10];}        if($return_half[11]!=0){            echo"<br>پرداخت اینترنتی :".$return_half[11];}echo"</td> ";				echo "</tr>";$total_price=0;			}}                $total_half_order_last=$return_half[0]+$return_half[1]+$return_half[2]+$return_half[3]+$return_half[4]+$return_half[5] ;			?>            <tr>            <td colspan="5"><div  align="left" >جمع کل: <?=  number_format($total_factor_price)?></div></td>                <td><div  align="left" >جمع دریافتی: <?=  number_format( $total_half_order_last)?></div></td>            </tr>            <tr>                <td colspan="7"><div  align="left" >در انتظار پرداخت: <?=  number_format($total_factor_price-$total_half_order_last)?></div></td>            </tr>		</table >        <table width="100%" cellspacing="15"  border="1"><tr>        <td>پرداخت نقدی:<?= number_format($return_half[0]) ?>  تومان</td>        <td>POS پرداخت : <?=  number_format($return_half[1]) ?> تومان</td>        <td>پرداخت چک: <?=  number_format($return_half[2]) ?>  تومان</td>        <td>واریزی حساب: <?=  number_format($return_half[3]) ?>  تومان</td>        <td>حسابداری: <?=  number_format($return_half[4]) ?>  تومان</td>        <td>اینترنتی: <?=  number_format($return_half[5]) ?>  تومان</td>